{{ range $host, $containers := groupBy $ "Env.VIRTUAL_HOST" }}
server {
    listen 80;
    resolver 127.0.0.11;
    server_name {{ $host }};
    access_log /var/log/nginx/{{ $host }}.com_access.log;

    location /sawtooth/ {
        auth_basic            "Private net";
        auth_basic_user_file  /etc/nginx/.htpasswd;
        proxy_set_header      Host {{ $host }};
        proxy_set_header      X-Real-IP $remote_addr;
        proxy_set_header      X-Forwarded-Path "/sawtooth";
        proxy_pass            http://{{ $host }}:8008/;
    }

    location /sawtooth-ws/ {
        proxy_pass http://{{ $host }}:8008/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
{{ end }}